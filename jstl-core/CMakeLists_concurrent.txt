# CMakeLists.txt with Concurrent HashMap Support
#
# To build with TBB support (recommended for low contention):
#   cmake -DUSE_TBB=ON ..
#   make
#
# To build with std::shared_mutex (fallback, higher contention):
#   cmake ..
#   make

cmake_minimum_required(VERSION 3.15)
project(jstl_native VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# Option to enable TBB
option(USE_TBB "Use Intel TBB for concurrent data structures" OFF)

# Source files
set(SOURCES
    native/src/jstl_arraylist.cpp
    native/src/jstl_hashmap.cpp
    native/src/jstl_hashset.cpp
)

# Add concurrent hash map implementation
if(USE_TBB)
    message(STATUS "Building with Intel TBB support (low contention)")
    find_package(TBB REQUIRED)
    list(APPEND SOURCES native/src/jstl_concurrent_hashmap_tbb.cpp)
    add_compile_definitions(USE_TBB)
else()
    message(STATUS "Building with std::shared_mutex (medium contention)")
    list(APPEND SOURCES native/src/jstl_concurrent_hashmap_mutex.cpp)
endif()

# Create shared library
add_library(jstl SHARED ${SOURCES})

# Link TBB if enabled
if(USE_TBB)
    target_link_libraries(jstl PRIVATE TBB::tbb)
endif()

# Set output directory
set_target_properties(jstl PROPERTIES
    LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
)

# Include directories
target_include_directories(jstl PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/native/include
)

# Installation
install(TARGETS jstl
    LIBRARY DESTINATION lib
    RUNTIME DESTINATION lib
)

# Print build configuration
message(STATUS "==============================================")
message(STATUS "JSTL Build Configuration:")
message(STATUS "  C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "  Concurrent Support: ${USE_TBB}")
if(USE_TBB)
    message(STATUS "  TBB Version: ${TBB_VERSION}")
    message(STATUS "  Contention Overhead: ~2-3x (Low)")
else()
    message(STATUS "  Contention Overhead: ~3-10x (Medium)")
endif()
message(STATUS "==============================================")
